generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}


model User {
  id                Int               @id @default(autoincrement())
  email             String            @unique
  password          String
  name              String?
  phone             String?
  cedula            String?
  fiatBalance       Float             @default(0.0)
  cacaoBalance      Float             @default(0.0)
  cacaoLocked       Float             @default(0.0) // En proceso de retiro/venta
  // Datos bancarios personales del usuario
  bankCountry       String?
  bankName          String?
  bankAccount       String?
  bankHolder        String?
  bankType          String?           // "corriente" | "ahorro"
  transactions      Transaction[]
  role              String            @default("user") // "admin" | "cajero" | "oficinista" | "user"
  status            String            @default("active") // "active" | "blocked"
  depositsAsUser    PhysicalDeposit[] @relation("UserDeposits")
  depositsAsInspector PhysicalDeposit[] @relation("InspectorDeposits")
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

model BankOption {
  id            Int           @id @default(autoincrement())
  country       String
  bankName      String
  accountHolder String
  accountNumber String
  accountType   String?
  notes         String?
  isActive      Boolean       @default(true)
  transactions  Transaction[]
  createdAt     DateTime      @default(now())
}

model PaymentMethod {
  id            Int      @id @default(autoincrement())
  type          String   // "FIAT" o "CRYPTO"
  name          String   // Ejemplo: "Banesco", "Binance Pay", "Zelle"
  currency      String   // "VES", "USDT", "USD"
  details       Json     // Datos de la cuenta (Cédula, Teléfono, Wallet Address, Red)
  instructions  String?  // Ejemplo: "Enviar solo por red TRC20"
  isActive      Boolean  @default(true)
  transactions  Transaction[]
}

model Transaction {
  id                Int           @id @default(autoincrement())
  userId            Int
  user              User          @relation(fields: [userId], references: [id])
  paymentMethodId   Int?
  paymentMethod     PaymentMethod? @relation(fields: [paymentMethodId], references: [id])
  type              String        // "DEPOSIT_CACAO", "WITHDRAW_USD", "BUY", "SELL", etc.
  status            String        @default("PENDING") // "PENDING", "COMPLETED", "REJECTED"
  // Montos
  amount            Float         // Cantidad principal (histórico/legacy)
  fiatAmount        Float?        // Monto pagado/recibido (ej. 1000 VES)
  gramsAmount       Float?        // Gramos de cacao involucrados
  exchangeRate      Float?        // Tasa USD/VES en ese momento
  cacaoPriceUSD     Float?        // Precio Cacao/USD en ese momento
  amountUSD         Float?        // Equivalente en USD (para conversiones/depósitos)
  amountCacao       Float?        // Equivalente en cacao (para conversiones/depósitos)
  priceAt           Float?        // Precio del cacao al momento (USD/g)
  // Verificación P2P
  reference         String?       // El Hash de la red o el número de referencia bancaria
  receiptImage      String?       // Link opcional a la foto del comprobante
  adminNotes        String?       // Por si el cajero rechaza por referencia inválida
  method            String?       // "BANK" | "OFFICE" (legacy)
  bankOptionId      Int?
  bankOption        BankOption?   @relation(fields: [bankOptionId], references: [id])
  notes             String?       // legacy notes
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
}

model SystemConfig {
  id                  Int      @id @default(1)
  buyPrice            Float    @default(3.50)  // Precio al que compramos cacao (USD/g)
  sellPrice           Float    @default(4.00)  // Precio al que vendemos cacao (USD/g)
  maintenanceFee      Float    @default(1.00)  // Tasa de mantenimiento mensual (USD)
  networkFee          Float    @default(0.10)  // Tasa de uso de red por transacción (USD)
  usdVesRate          Float    @default(36.50) // Tasa USD-VES para cálculos informativos
  marketTonPrice      Float?                   // Precio de referencia mercado mundial (USD/Ton)
  lastMarketPrice     Float?                   // Último precio de referencia mercado mundial (USD/g)
  updatedAt           DateTime @updatedAt
}


model GlobalReserve {
  id              Int      @id @default(1)
  totalCacaoStock Float    @default(0) // Cacao físico en almacén (gramos)
  tokensIssued    Float    @default(0) // Gramos en manos de clientes
  lastUpdated     DateTime @updatedAt
}

model CollectionCenter {
  id              Int               @id @default(autoincrement())
  name            String            // Ejemplo: "Acopio Central Quevedo"
  address         String            // Dirección textual
  city            String
  phone           String?
  managerName     String?           // Persona responsable
  operatingHours  String            // Ejemplo: "Lun-Vie 08:00 - 17:00"
  // Datos Geográficos
  latitude        Float?            // Para posicionar el pin exactamente
  longitude       Float?
  googleMapsUrl   String?           // El link que se abrirá en el móvil (https://maps.google.com/...)
  // Inventario local (Opcional pero recomendado)
  currentStock    Float             @default(0) // Cuánto cacao físico hay en este centro específico  
  isActive        Boolean           @default(true)
  deposits        PhysicalDeposit[]
  createdAt       DateTime          @default(now())
}

model PhysicalDeposit {
  id                Int              @id @default(autoincrement())
  userId            Int
  user              User             @relation("UserDeposits", fields: [userId], references: [id])
  centerId          Int
  center            CollectionCenter @relation(fields: [centerId], references: [id])
  inspectorId       Int
  inspector         User             @relation("InspectorDeposits", fields: [inspectorId], references: [id])
  
  grossWeight       Float            // Peso bruto entregado
  qualityGrade      String           // "PREMIUM", "GRADO_1", "GRADO_2"
  moistureContent   Float            // % de humedad
  fermentationGrade Float            // % de fermentación
  impuritiesContent Float            // % de impurezas
  
  conversionFactor  Float            // E.g., 1.0 para Premium, 0.7 para Grado 2
  finalTokensIssued Float            // Los gramos netos acreditados (grossWeight * conversionFactor con ajustes adicionales)
  
  status            String           @default("PENDING") // PENDING, VERIFIED, REJECTED
  notes             String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
}
